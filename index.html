<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Anh Ten Nau</title>
<style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f8f9fa; }
    #editor { width: 100%; height: 150px; border: 1px solid #ccc; padding: 8px; margin-bottom: 10px; overflow: auto; }
    textarea { width: 100%; height: 150px; font-size: 16px; padding: 8px; }
    button { margin-right: 10px; padding: 8px 16px; cursor: pointer; font-size: 14px; }
</style>
</head>
<body>

<h2>Text Converter: BBCode ↔ HTML ↔ Plain Text</h2>

<div id="editor" contenteditable="true" placeholder="Paste văn bản từ Word/Docs vào đây..."></div><br>

<button onclick="convertRichTextToBBCode()">BBCode (Xóa dấu)</button>
<button onclick="convertRichTextToBBCodeKeepDiacritics()">BBCode (Giữ dấu)</button>
<button onclick="convertTextToHTML()">HTML (Xóa dấu)</button>
<button onclick="convertTextToHTMLKeepDiacritics()">HTML (Giữ dấu)</button>
<!-- <button onclick="removeDiacriticsOnly()">Chỉ Xóa dấu</button> -->
<button onclick="resetText()">Reset</button>

<h3>Kết quả:</h3>
<textarea id="outputText" readonly></textarea>

<script>



// Hàm làm sạch HTML để tránh format lồng nhau và lỗi BBCode
function cleanupHTML(html) {
    // Loại bỏ thẻ <b> bao quanh toàn bộ nội dung (thường do paste lỗi)
    if (html.startsWith('<b>') && html.endsWith('</b>')) {
        html = html.slice(3, -4); // Loại bỏ <b> đầu và </b> cuối
    }
    
    // Loại bỏ thẻ <b> rỗng hoặc chỉ chứa khoảng trắng
    html = html.replace(/<b>\s*<\/b>/gi, '');
    html = html.replace(/<b><\/b>/gi, '');
    
    // Loại bỏ các span, div không cần thiết
    html = html.replace(/<span[^>]*>/gi, '').replace(/<\/span>/gi, '');
    html = html.replace(/<div[^>]*>/gi, '').replace(/<\/div>/gi, '\n');
    
    // Loại bỏ các tag lồng nhau thừa
    html = html.replace(/<(b|strong)([^>]*)><(b|strong)([^>]*)>/gi, '<$1$2>');
    html = html.replace(/<\/(b|strong)><\/(b|strong)>/gi, '</$1>');
    html = html.replace(/<(i|em)([^>]*)><(i|em)([^>]*)>/gi, '<$1$2>');
    html = html.replace(/<\/(i|em)><\/(i|em)>/gi, '</$1>');
    
    // Loại bỏ các attribute không cần thiết
    html = html.replace(/\s+(style|class|id|data-[^=]*)\s*=\s*["'][^"']*["']/gi, '');
    
    // Chuẩn hóa các tag
    html = html.replace(/<p[^>]*>/gi, '<p>');
    html = html.replace(/<br[^>]*>/gi, '<br>');
    
    // Loại bỏ whitespace thừa
    html = html.replace(/>\s+</g, '><');
    
    // Xử lý trường hợp đặc biệt: <b> bao quanh toàn bộ nội dung ở cuối
    html = html.replace(/^<b>([\s\S]*)<\/b>$/gi, '$1');
    
    // Loại bỏ các thẻ <b> thừa khác
    html = html.replace(/<b>\s*(<h[1-6])/gi, '$1'); // <b><h1> -> <h1>
    html = html.replace(/(<\/h[1-6]>)\s*<\/b>/gi, '$1'); // </h1></b> -> </h1>
    html = html.replace(/<b>\s*(<p>)/gi, '$1'); // <b><p> -> <p>
    html = html.replace(/(<\/p>)\s*<\/b>/gi, '$1'); // </p></b> -> </p>
    
    return html;
}

function removeVietnameseDiacritics(text) {
    return text
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/đ/g, "d")
        .replace(/Đ/g, "D");
}

function convertRichTextToBBCode() {
    let editor = document.getElementById("editor");
    let html = editor.innerHTML;

    // Làm sạch HTML trước khi xử lý để tránh lỗi format lồng nhau
    html = cleanupHTML(html);

    let bb = html
        .replace(/<h[1-6][^>]*>(.*?)<\/h[1-6]>/gi, "[b]$1[/b]\n\n")
        .replace(/<b>(.*?)<\/b>/gi, "[b]$1[/b]")
        .replace(/<strong>(.*?)<\/strong>/gi, "[b]$1[/b]")
        .replace(/<i>(.*?)<\/i>/gi, "[i]$1[/i]")
        .replace(/<em>(.*?)<\/em>/gi, "[i]$1[/i]")
        .replace(/<u>(.*?)<\/u>/gi, "[u]$1[/u]")
        .replace(/<a\s+href="(.*?)"[^>]*>(.*?)<\/a>/gi, "[url=$1]$2[/url]")
        .replace(/<br\s*\/?>/gi, "\n")
        .replace(/<\/p>/gi, "\n\n")
        .replace(/<p[^>]*>/gi, "")
        .replace(/<\/div>/gi, "\n")
        .replace(/<div[^>]*>/gi, "")
        .replace(/<\/span><\/span>/gi, "\n\n")
        .replace(/<\/span>/gi, "");

    bb = bb.replace(/<\/?[^>]+(>|$)/g, "");
    
    // Xóa các HTML entities
    bb = bb.replace(/&nbsp;/g, " ")
           .replace(/&amp;/g, "&")
           .replace(/&lt;/g, "<")
           .replace(/&gt;/g, ">")
           .replace(/&quot;/g, '"')
           .replace(/&#39;/g, "'");
    
    bb = bb.replace(/[ \t]+/g, " ")  // Chỉ thay nhiều space/tab thành 1 space, không touch xuống dòng
           .replace(/[ \t]*\n[ \t]*/g, "\n")  // Loại bỏ space/tab xung quanh xuống dòng
           .replace(/\n{3,}/g, "\n\n");  // Giới hạn tối đa 2 xuống dòng liên tiếp
    
    let result = "";
    let i = 0;
    while (i < bb.length) {
        if (bb[i] === '[') {
            // Tìm tag BBCode và giữ nguyên
            let tagEnd = bb.indexOf(']', i);
            if (tagEnd !== -1) {
                result += bb.substring(i, tagEnd + 1);
                i = tagEnd + 1;
            } else {
                result += removeVietnameseDiacritics(bb[i]);
                i++;
            }
        } else {
            result += removeVietnameseDiacritics(bb[i]);
            i++;
        }
    }

    document.getElementById("outputText").value = result.trim();
}

function convertRichTextToBBCodeKeepDiacritics() {
    let editor = document.getElementById("editor");
    let html = editor.innerHTML;
    
    // Làm sạch HTML trước khi xử lý để tránh lỗi format lồng nhau
    html = cleanupHTML(html);
    
    let bb = html
        .replace(/<h[1-6][^>]*>(.*?)<\/h[1-6]>/gi, "[b]$1[/b]\n\n")
        .replace(/<b>(.*?)<\/b>/gi, "[b]$1[/b]")
        .replace(/<strong>(.*?)<\/strong>/gi, "[b]$1[/b]")
        .replace(/<i>(.*?)<\/i>/gi, "[i]$1[/i]")
        .replace(/<em>(.*?)<\/em>/gi, "[i]$1[/i]")
        .replace(/<u>(.*?)<\/u>/gi, "[u]$1[/u]")
        .replace(/<a\s+href="(.*?)"[^>]*>(.*?)<\/a>/gi, "[url=$1]$2[/url]")
        .replace(/<br\s*\/?>/gi, "\n")
        .replace(/<\/p>/gi, "\n\n")
        .replace(/<p[^>]*>/gi, "")
        .replace(/<\/div>/gi, "\n")
        .replace(/<div[^>]*>/gi, "")
        .replace(/<\/span><\/span>/gi, "\n\n")
        .replace(/<\/span>/gi, "");

    bb = bb.replace(/<\/?[^>]+(>|$)/g, "");
    
    // Xóa các HTML entities
    bb = bb.replace(/&nbsp;/g, " ")
           .replace(/&amp;/g, "&")
           .replace(/&lt;/g, "<")
           .replace(/&gt;/g, ">")
           .replace(/&quot;/g, '"')
           .replace(/&#39;/g, "'");
    
    bb = bb.replace(/[ \t]+/g, " ")  
           .replace(/[ \t]*\n[ \t]*/g, "\n") 
           .replace(/\n{3,}/g, "\n\n");
    
    document.getElementById("outputText").value = bb.trim();
}

function convertTextToHTML() {
    let editor = document.getElementById("editor");
    let html = editor.innerHTML;

    // Làm sạch HTML trước khi xử lý
    html = cleanupHTML(html);

    let cleanHtml = html
        .replace(/<span[^>]*>/gi, '')
        .replace(/<\/span>/gi, '')
        .replace(/<div[^>]*>/gi, '')
        .replace(/<\/div>/gi, '');

    cleanHtml = cleanHtml
        .replace(/<a[^>]*href\s*=\s*["']([^"']+)["'][^>]*>(.*?)<\/a>/gi, '<a href="$1">$2</a>');

    cleanHtml = cleanHtml.replace(/<h([1-6])[^>]*>(.*?)<\/h\1>/gis, function (_, level, content) {
        // Loại bỏ tất cả formatting bên trong heading để tránh conflict
        let noP = content.replace(/<\/?p[^>]*>/gi, '');
        // Loại bỏ bold/strong tags để tránh nested formatting
        noP = noP.replace(/<\/?(?:b|strong)[^>]*>/gi, '');
        // Loại bỏ italic tags
        noP = noP.replace(/<\/?(?:i|em)[^>]*>/gi, '');
        // Loại bỏ underline tags
        noP = noP.replace(/<\/?u[^>]*>/gi, '');
        // Lấy text thuần, loại bỏ mọi tag còn lại
        noP = noP.replace(/<[^>]*>/g, '');
        return `<h${level}><strong>${noP}</strong></h${level}>`;
    });

    cleanHtml = cleanHtml.replace(/<p[^>]*>/gi, '<p>');

    cleanHtml = cleanHtml.replace(/<br[^>]*>/gi, '<br />');

    // Remove id and style attributes
    cleanHtml = cleanHtml
        .replace(/\s+id\s*=\s*["'][^"']*["']/gi, '')
        .replace(/\s+style\s*=\s*["'][^"']*["']/gi, '');

    cleanHtml = cleanHtml
        .replace(/&nbsp;/g, ' ')
        .replace(/&amp;/g, '&')
        .replace(/&lt;/g, '<')
        .replace(/&gt;/g, '>')
        .replace(/&quot;/g, '"')
        .replace(/&#39;/g, "'");

    cleanHtml = cleanHtml.replace(/<(\w+)>\s*<\/\1>/gi, '');

    let result = "";
    let i = 0;
    while (i < cleanHtml.length) {
        if (cleanHtml[i] === '<') {
            let tagEnd = cleanHtml.indexOf('>', i);
            if (tagEnd !== -1) {
                result += cleanHtml.substring(i, tagEnd + 1);
                i = tagEnd + 1;
            } else {
                result += removeVietnameseDiacritics(cleanHtml[i]);
                i++;
            }
        } else {
            result += removeVietnameseDiacritics(cleanHtml[i]);
            i++;
        }
    }

    result = result
        .replace(/\s+/g, ' ')
        .replace(/>\s+</g, '><')
        .replace(/<\/h[1-6]>/gi, '$&\n\n')
        .replace(/<\/p>/gi, '$&\n\n')
        .replace(/<br\s*\/?>/gi, '\n')
        .replace(/\n{3,}/g, '\n\n')
        .replace(/<(h[1-6]|p)>\s*(.*?)\s*<\/\1>/gi, '<$1>$2</$1>')
        .trim();

    result += '\n\n<p><br />\n </p>';

    document.getElementById("outputText").value = result;
}

function convertTextToHTMLKeepDiacritics() {
    let editor = document.getElementById("editor");
    let html = editor.innerHTML;

    // Làm sạch HTML trước khi xử lý
    html = cleanupHTML(html);

    let cleanHtml = html
        .replace(/<span[^>]*>/gi, '')
        .replace(/<\/span>/gi, '')
        .replace(/<div[^>]*>/gi, '')
        .replace(/<\/div>/gi, '');

    cleanHtml = cleanHtml
        .replace(/<a[^>]*href\s*=\s*["']([^"']+)["'][^>]*>(.*?)<\/a>/gi, '<a href="$1">$2</a>');

    cleanHtml = cleanHtml.replace(/<h([1-6])[^>]*>(.*?)<\/h\1>/gis, function (_, level, content) {
        let noP = content.replace(/<\/?p[^>]*>/gi, '');
        return `<h${level}><strong>${noP}</strong></h${level}>`;
    });

    cleanHtml = cleanHtml.replace(/<p[^>]*>/gi, '<p>');

    cleanHtml = cleanHtml.replace(/<br[^>]*>/gi, '<br />');

    // Remove id and style attributes
    cleanHtml = cleanHtml
        .replace(/\s+id\s*=\s*["'][^"']*["']/gi, '')
        .replace(/\s+style\s*=\s*["'][^"']*["']/gi, '');

    cleanHtml = cleanHtml
        .replace(/&nbsp;/g, ' ')
        .replace(/&amp;/g, '&')
        .replace(/&lt;/g, '<')
        .replace(/&gt;/g, '>')
        .replace(/&quot;/g, '"')
        .replace(/&#39;/g, "'");

    cleanHtml = cleanHtml.replace(/<(\w+)>\s*<\/\1>/gi, '');

    // Clean HTML without removing Vietnamese diacritics
    let result = cleanHtml
        .replace(/\s+/g, ' ')
        .replace(/>\s+</g, '><')
        .replace(/<\/h[1-6]>/gi, '$&\n\n')
        .replace(/<\/p>/gi, '$&\n\n')
        .replace(/<br\s*\/?>/gi, '\n')
        .replace(/\n{3,}/g, '\n\n')
        .replace(/<(h[1-6]|p)>\s*(.*?)\s*<\/\1>/gi, '<$1>$2</$1>')
        .trim();

    result += '\n\n<p><br />\n </p>';

    document.getElementById("outputText").value = result;
}

function removeVietnameseDiacritics(str) {
    const accentsMap = [
        { base: 'a', letters: /[àáạảãâầấậẩẫăằắặẳẵ]/g },
        { base: 'A', letters: /[ÀÁẠẢÃÂẦẤẬẨẪĂẰẮẶẲẴ]/g },
        { base: 'e', letters: /[èéẹẻẽêềếệểễ]/g },
        { base: 'E', letters: /[ÈÉẸẺẼÊỀẾỆỂỄ]/g },
        { base: 'i', letters: /[ìíịỉĩ]/g },
        { base: 'I', letters: /[ÌÍỊỈĨ]/g },
        { base: 'o', letters: /[òóọỏõôồốộổỗơờớợởỡ]/g },
        { base: 'O', letters: /[ÒÓỌỎÕÔỒỐỘỔỖƠỜỚỢỞỠ]/g },
        { base: 'u', letters: /[ùúụủũưừứựửữ]/g },
        { base: 'U', letters: /[ÙÚỤỦŨƯỪỨỰỬỮ]/g },
        { base: 'y', letters: /[ỳýỵỷỹ]/g },
        { base: 'Y', letters: /[ỲÝỴỶỸ]/g },
        { base: 'd', letters: /[đ]/g },
        { base: 'D', letters: /[Đ]/g }
    ];
    accentsMap.forEach(accent => {
        str = str.replace(accent.letters, accent.base);
    });
    return str;
}

function removeDiacriticsOnly() {
    let editor = document.getElementById("editor");
    let text = editor.innerText.trim();
    document.getElementById("outputText").value = removeVietnameseDiacritics(text);
}

function resetText() {
    document.getElementById("editor").innerHTML = "";
    document.getElementById("outputText").value = "";
}
</script>

</body>
</html>
